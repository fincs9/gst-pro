<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GST PRO - Independent Demo</title>
    
    <!-- Professional CDNs -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { background-color: #f8fafc; font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; -webkit-tap-highlight-color: transparent; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; height: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #2563eb; border-radius: 10px; }
        .books-row { background-color: #eff6ff; border-left: 4px solid #3b82f6; }
        .portal-row { background-color: #fff7ed; border-left: 4px solid #f97316; }
        
        @media (max-width: 640px) {
            .mobile-hide { display: none; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- BROWSER DATABASE (IndexedDB) ---
        const DB_NAME = 'GST_PRO_PRIVATE_DEMO';
        const STORE_NAME = 'session_storage';
        const DB_VERSION = 1;

        const openDB = () => {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onupgradeneeded = (e) => e.target.result.createObjectStore(STORE_NAME);
                request.onsuccess = (e) => resolve(e.target.result);
                request.onerror = () => reject();
            });
        };

        const saveState = async (state) => {
            const db = await openDB();
            const tx = db.transaction(STORE_NAME, 'readwrite');
            tx.objectStore(STORE_NAME).put(state, 'current_state');
        };

        const loadState = async () => {
            const db = await openDB();
            const tx = db.transaction(STORE_NAME, 'readonly');
            return new Promise((resolve) => {
                const request = tx.objectStore(STORE_NAME).get('current_state');
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => resolve(null);
            });
        };

        const App = () => {
            const [data, setData] = useState({ invoices: [], glBalances: { igst: 0, cgst: 0, sgst: 0 } });
            const [activeTab, setActiveTab] = useState('dashboard');
            const [loading, setLoading] = useState(true);
            const [searchTerm, setSearchTerm] = useState('');
            const fileInputRef = useRef(null);

            useEffect(() => {
                const init = async () => {
                    const saved = await loadState();
                    if (saved) setData(saved);
                    setLoading(false);
                    setTimeout(() => lucide.createIcons(), 100);
                };
                init();
            }, []);

            useEffect(() => { lucide.createIcons(); }, [activeTab, data, searchTerm]);

            // --- MATCHING ENGINE ---
            const recon = useMemo(() => {
                const books = data.invoices.filter(i => i.source === 'books');
                const portal = data.invoices.filter(i => i.source === '2a');

                const portalMap = {};
                portal.forEach(item => {
                    const key = normalize(item.invoiceNo);
                    if (!portalMap[key]) portalMap[key] = [];
                    portalMap[key].push(item);
                });

                const results = [];
                const matchedPortalIds = new Set();

                books.forEach(book => {
                    const key = normalize(book.invoiceNo);
                    const candidates = portalMap[key] || [];
                    let match = candidates.find(p => normalize(p.gstin) === normalize(book.gstin));
                    if (match) matchedPortalIds.add(match.id);

                    results.push({
                        id: book.id,
                        uniqueId2A: match?.uniqueIdA || 'N/A',
                        vendor: book.vendor || match?.vendor || 'N/A',
                        gstin: book.gstin,
                        booksInv: book.invoiceNo,
                        portalInv: match?.invoiceNo || '-',
                        booksDate: book.invoiceDate,
                        portalDate: match?.invoiceDate || '-',
                        booksTax: (book.igst || 0) + (book.cgst || 0) + (book.sgst || 0),
                        portalTax: (match?.igst || 0) + (match?.cgst || 0) + (match?.sgst || 0),
                        status: !match ? 'missing' : (match.invoiceDate === book.invoiceDate ? 'matched' : 'mismatch')
                    });
                });

                portal.forEach(p => {
                    if (!matchedPortalIds.has(p.id)) {
                        results.push({
                            id: p.id, uniqueId2A: p.uniqueIdA || '-', vendor: p.vendor, gstin: p.gstin,
                            booksInv: '-', portalInv: p.invoiceNo, booksDate: '-', portalDate: p.invoiceDate,
                            booksTax: 0, portalTax: (p.igst || 0) + (p.cgst || 0) + (p.sgst || 0),
                            status: 'extra'
                        });
                    }
                });

                return results;
            }, [data.invoices]);

            const normalize = (s) => String(s || "").replace(/[^a-zA-Z0-9]/g, "").toUpperCase();
            const formatINR = (v) => new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR', maximumFractionDigits: 0 }).format(v || 0);

            const handleUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const is2A = confirm("Standard 2A File? (OK for 2A, Cancel for Books)");
                const source = is2A ? '2a' : 'books';

                const reader = new FileReader();
                reader.onload = async (evt) => {
                    try {
                        const workbook = XLSX.read(evt.target.result, { type: 'binary' });
                        const rows = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { header: 1 });
                        const newRecords = [];

                        rows.slice(1).forEach((row) => {
                            if (!row[0] && !row[9]) return;
                            let record = { source, id: `id_${Date.now()}_${Math.random()}` };
                            if (source === 'books') {
                                // Logic.xlsx NOV 25: H(7)=GSTIN, J(9)=InvNo, K(10)=Date, N(13),O(14),P(15)
                                record.gstin = String(row[7] || "").trim();
                                record.vendor = String(row[8] || "");
                                record.invoiceNo = String(row[9] || "").trim();
                                record.invoiceDate = String(row[10] || "");
                                record.igst = parseFloat(row[13]) || 0;
                                record.cgst = parseFloat(row[14]) || 0;
                                record.sgst = parseFloat(row[15]) || 0;
                            } else {
                                // Logic.xlsx 2A: A(0)=UniqueID, B(1)=InvNo, C(2)=Date, D(3)=GSTIN, F(5),G(6),H(7)
                                record.uniqueIdA = String(row[0] || "");
                                record.invoiceNo = String(row[1] || "").trim();
                                record.invoiceDate = String(row[2] || "");
                                record.gstin = String(row[3] || "").trim();
                                record.igst = parseFloat(row[5]) || 0;
                                record.cgst = parseFloat(row[6]) || 0;
                                record.sgst = parseFloat(row[7]) || 0;
                            }
                            if (record.invoiceNo) newRecords.push(record);
                        });

                        const updated = { ...data, invoices: [...data.invoices, ...newRecords] };
                        setData(updated);
                        await saveState(updated);
                        alert(`Loaded ${newRecords.length} records.`);
                    } catch (err) { alert(err.message); }
                    e.target.value = '';
                };
                reader.readAsBinaryString(file);
            };

            const resetData = async () => {
                if (confirm("Reset Session? This wipes your browser database.")) {
                    const reset = { invoices: [], glBalances: { igst: 0, cgst: 0, sgst: 0 } };
                    setData(reset);
                    await saveState(reset);
                }
            };

            if (loading) return <div className="h-screen flex items-center justify-center font-black text-blue-600 animate-pulse uppercase">GST PRO ENGINE...</div>;

            return (
                <div className="min-h-screen flex flex-col">
                    <header className="bg-white border-b p-3 px-6 flex flex-col sm:flex-row justify-between items-center sticky top-0 z-50 shadow-sm gap-4">
                        <div className="flex items-center gap-3 w-full sm:w-auto">
                            <div className="bg-blue-600 text-white p-2 rounded-xl shadow-lg"><i data-lucide="shield-check"></i></div>
                            <h1 className="text-xl font-black tracking-tighter text-slate-800">GST PRO</h1>
                            <div className="flex-1"></div>
                            <button onClick={resetData} className="sm:hidden text-slate-300 hover:text-red-500 p-2"><i data-lucide="trash-2"></i></button>
                        </div>

                        <nav className="flex bg-slate-100 p-1 rounded-xl gap-1 w-full sm:w-auto">
                            <button onClick={() => setActiveTab('dashboard')} className={`flex-1 sm:flex-none px-6 py-2 rounded-lg text-xs font-bold transition-all ${activeTab === 'dashboard' ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-500'}`}>DASHBOARD</button>
                            <button onClick={() => setActiveTab('recon')} className={`flex-1 sm:flex-none px-6 py-2 rounded-lg text-xs font-bold transition-all ${activeTab === 'recon' ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-500'}`}>RECONCILIATION</button>
                        </nav>

                        <div className="flex items-center gap-4 w-full sm:w-auto">
                            <button onClick={resetData} className="hidden sm:block text-slate-300 hover:text-red-500 p-2"><i data-lucide="trash-2"></i></button>
                            <button onClick={() => fileInputRef.current.click()} className="flex-1 sm:flex-none bg-blue-600 text-white px-6 py-2.5 rounded-xl font-bold text-xs shadow-md hover:bg-blue-700">UPLOAD DATA</button>
                            <input type="file" ref={fileInputRef} hidden accept=".xlsx, .xls, .csv" onChange={handleUpload} />
                        </div>
                    </header>

                    <main className="p-4 md:p-8 max-w-[1600px] mx-auto w-full flex-1">
                        {activeTab === 'dashboard' ? (
                            <div className="space-y-6">
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                    <div className="bg-white p-6 md:p-8 rounded-3xl shadow-sm border border-slate-100 border-l-8 border-blue-600">
                                        <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Register ITC</p>
                                        <h2 className="text-2xl md:text-3xl font-black mt-2 text-slate-800">{formatINR(recon.filter(r => r.booksInv !== '-').reduce((s,i) => s + i.booksTax, 0))}</h2>
                                    </div>
                                    <div className="bg-white p-6 md:p-8 rounded-3xl shadow-sm border border-slate-100 border-l-8 border-green-500">
                                        <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Matched Pairs</p>
                                        <h2 className="text-2xl md:text-3xl font-black text-green-600 mt-2">{recon.filter(r => r.status === 'matched').length}</h2>
                                    </div>
                                    <div className="bg-slate-900 p-6 md:p-8 rounded-3xl shadow-xl text-white flex items-center justify-between">
                                        <div>
                                            <p className="text-[10px] font-bold opacity-50 uppercase tracking-widest">Database</p>
                                            <h2 className="text-xs md:text-sm font-black mt-1 uppercase tracking-widest">Offline Secure</h2>
                                        </div>
                                        <i data-lucide="database" className="w-10 h-10 opacity-20"></i>
                                    </div>
                                </div>
                                <div className="bg-blue-50 border border-blue-100 p-6 rounded-3xl flex gap-4">
                                    <i data-lucide="info" className="text-blue-500 mt-1 shrink-0"></i>
                                    <p className="text-[10px] sm:text-xs text-blue-800 leading-relaxed font-medium uppercase tracking-tight">
                                        <strong>Privacy:</strong> All data uploaded is stored in your <strong>Local Browser Memory</strong>. If your friend opens this link, he will see a clean system. Your internal corporate data is never uploaded to the cloud.
                                    </p>
                                </div>
                            </div>
                        ) : (
                            <div className="bg-white rounded-3xl shadow-lg border border-slate-200 flex flex-col h-[calc(100vh-250px)] overflow-hidden">
                                <div className="p-4 bg-slate-50 border-b flex flex-col md:flex-row justify-between items-center gap-4">
                                    <input type="text" placeholder="Search..." className="w-full md:w-96 pl-4 py-2 rounded-xl border border-slate-200 text-sm outline-none shadow-sm" value={searchTerm} onChange={e => setSearchTerm(e.target.value)} />
                                    <div className="flex gap-4 text-[9px] md:text-[10px] font-black text-slate-400 uppercase tracking-widest self-start md:self-auto">
                                        <div className="flex items-center gap-1"><span className="w-2.5 h-2.5 rounded bg-blue-100 border shadow-sm"></span> Books (J)</div>
                                        <div className="flex items-center gap-1"><span className="w-2.5 h-2.5 rounded bg-orange-50 border shadow-sm"></span> Portal (B)</div>
                                    </div>
                                </div>
                                <div className="flex-1 overflow-auto custom-scrollbar">
                                    <table className="w-full text-left border-collapse min-w-[1000px] md:min-w-[1300px]">
                                        <thead className="sticky top-0 bg-white shadow-sm z-10 border-b">
                                            <tr className="text-[9px] md:text-[10px] font-black text-slate-400 uppercase tracking-widest">
                                                <th className="px-6 py-4">2A Unique ID (Col A)</th>
                                                <th className="px-6 py-4 text-center border-x">Verification Pair</th>
                                                <th className="px-6 py-4 text-right border-r mobile-hide">Register Tax</th>
                                                <th className="px-6 py-4 text-right border-r mobile-hide">Portal Tax</th>
                                                <th className="px-6 py-4 text-right">Variance</th>
                                                <th className="px-6 py-4 text-center">Verdict</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-slate-50">
                                            {recon.filter(r => (r.booksInv + r.uniqueId2A + r.vendor + r.gstin).toLowerCase().includes(searchTerm.toLowerCase())).map((row, idx) => (
                                                <tr key={idx} className="hover:bg-slate-50/50">
                                                    <td className="px-6 py-4">
                                                        <div className="font-mono text-[9px] md:text-[10px] text-blue-600 font-bold mb-1">{row.uniqueId2A}</div>
                                                        <div className="text-[10px] md:text-[11px] font-black text-slate-800 uppercase truncate max-w-[200px]">{row.vendor}</div>
                                                        <div className="text-[8px] md:text-[9px] text-slate-400 font-mono mobile-hide">{row.gstin}</div>
                                                    </td>
                                                    <td className="px-6 py-4 border-x bg-slate-50/20">
                                                        <div className="flex flex-col items-center gap-1.5">
                                                            <div className="flex gap-2 font-bold text-[9px] md:text-[10px]">
                                                                <span className="px-3 py-1 rounded bg-blue-50 text-blue-700 border">{row.booksInv}</span>
                                                                <i data-lucide="arrow-right-left" className="w-3 h-3 text-slate-300 mt-1"></i>
                                                                <span className="px-3 py-1 rounded bg-orange-50 text-orange-700 border">{row.portalInv}</span>
                                                            </div>
                                                        </div>
                                                    </td>
                                                    <td className="px-6 py-4 border-r text-right font-mono text-blue-700 font-bold text-xs mobile-hide">{formatINR(row.booksTax)}</td>
                                                    <td className="px-6 py-4 border-r text-right font-mono text-orange-700 font-bold text-xs mobile-hide">{formatINR(row.portalTax)}</td>
                                                    <td className={`px-6 py-4 text-right font-black text-[10px] md:text-xs ${Math.abs(row.booksTax - row.portalTax) > 1.2 ? 'text-red-500 bg-red-50' : 'text-green-600'}`}>{formatINR(row.booksTax - row.portalTax)}</td>
                                                    <td className="px-6 py-4 text-center">
                                                        {row.status === 'matched' ? <span className="text-green-500 font-black text-[8px] md:text-[9px] border border-green-100 bg-green-50 px-2 py-1 rounded-full uppercase">MATCHED</span> : 
                                                         row.status === 'missing' ? <span className="text-red-500 font-black text-[8px] md:text-[9px] border border-red-100 bg-red-50 px-2 py-1 rounded-full uppercase tracking-tighter">PENDING 2A</span> : 
                                                         <span className="text-amber-500 font-black text-[8px] md:text-[9px] border border-amber-100 bg-amber-50 px-2 py-1 rounded-full uppercase tracking-tighter">MISMATCH</span>}
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}
                    </main>
                    <footer className="p-3 bg-white border-t text-center text-[8px] md:text-[10px] text-slate-400 font-bold uppercase tracking-widest">
                        Independent GST Engine â€¢ Secure Browser Database
                    </footer>
                </div>
            );
        };

            const root = ReactDOM.createRoot(document.getElementById('root'));
            root.render(<App />);
    </script>
</body>
</html>